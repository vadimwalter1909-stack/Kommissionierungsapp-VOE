{% extends "base.html" %}

{% block content %}

{% set page_title = "Produktion – " ~ kuerzel %}
{% set back_url = "/produktion" %}

<nav class="app-nav">
    <div class="nav-left">
        <a href="{{ back_url }}" class="nav-back">←</a>
        <span class="nav-title">{{ page_title }}</span>
    </div>
</nav>

<div class="detail-container">

    {% if groups|length == 0 %}
        <p>Keine Produktionsdaten gefunden.</p>
    {% else %}

        {% for g in groups %}
        <div class="bundle {% if g.fertig %}bundle-fertig{% endif %}">

            <div class="bundle-header">
                <div class="bundle-title">
                    {{ g.artikel_nr }} — {{ g.durchmesser }} mm × {{ g.laenge }} mm
                </div>
                <div class="bundle-subtitle">
                    Gesamt: {{ g.menge }} Stk
                </div>
            </div>

            <div class="bundle-info">
                <p><strong>Artikel:</strong> {{ g.artikel_clean }}</p>
                <p><strong>Biegung:</strong> {{ g.biegung }}</p>
                <p><strong>ProdIDs:</strong> {{ g.prod_ids | join(", ") }}</p>
            </div>

            {% if not g.fertig %}
            <form method="post" action="/produktion/buendel_fertig" class="bundle-form">
                <input type="hidden" name="kuerzel" value="{{ kuerzel }}">
                <input type="hidden" name="start_bft" value="{{ start_bft }}">

                {% for rk in g.row_keys %}
                    <input type="hidden" name="row_keys" value="{{ rk }}">
                {% endfor %}

                <button type="submit" class="bundle-button">Bündel fertig</button>
            </form>
            {% else %}
            <div class="bundle-done-hint">✔ Bereits fertig</div>
            {% endif %}

        </div>
        {% endfor %}

    {% endif %}

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

    const saved = sessionStorage.getItem("scrollPosProd");
    if (saved) {
        window.scrollTo(0, parseInt(saved));
    }

    document.querySelectorAll("form.bundle-form").forEach(form => {
        form.addEventListener("submit", () => {
            sessionStorage.setItem("scrollPosProd", window.scrollY);
        });
    });
});
</script>

{% endblock %}
